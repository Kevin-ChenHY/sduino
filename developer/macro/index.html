<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Michael Mayer">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>C preprocessor macro magic - Sduino</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Sduino</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../..">Introduction</a>
</li>
                                    
<li >
    <a href="../../usage/board-manager-install/">Automatic Installation</a>
</li>
                                    
<li >
    <a href="../../usage/build-ide/">Building with the IDE</a>
</li>
                                    
<li >
    <a href="../../usage/faq/">FAQ/common problems</a>
</li>
                                    
<li >
    <a href="../../usage/why-stm8/">When to use an STM8S - and when not</a>
</li>
                                    
<li >
    <a href="../../usage/manual-install/">Manual Installation</a>
</li>
                                    
<li >
    <a href="../../usage/build-cli/">Building with a Makefile</a>
</li>
                                    
<li >
    <a href="../../usage/limitations/">Limitations</a>
</li>
                                    
<li >
    <a href="../../usage/status-todo/">Status and todo</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Libraries <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../api/migration/">API description and migration guidelines</a>
</li>
                                    
<li >
    <a href="../../api/Print/">Print</a>
</li>
                                    
<li >
    <a href="../../api/HardwareSerial/">HardwareSerial</a>
</li>
                                    
<li >
    <a href="../../api/SPI/">SPI</a>
</li>
                                    
<li >
    <a href="../../api/Wire/">Wire</a>
</li>
                                    
<li >
    <a href="../../api/I2C/">I2C</a>
</li>
                                    
<li >
    <a href="../../api/EEPROM/">EEPROM</a>
</li>
                                    
<li >
    <a href="../../api/LiquidCrystal/">LiquidCrystal character LCD library</a>
</li>
                                    
<li >
    <a href="../../api/LiquidCrystal_I2C/">LiquidCrystal_I2C character LCD connected via I2C backpack boards</a>
</li>
                                    
<li >
    <a href="../../api/LiquidCrystal_pcf2119/">LiquidCrystal_pcf2119 character LCD connected via I2C</a>
</li>
                                    
<li >
    <a href="../../api/PCD8544/">PCD8544 libray for Nokia 5110-like graphical LCDs</a>
</li>
                                    
<li >
    <a href="../../api/Mini_SSD1306/">Mini_SSD1306 library for monochrome OLED-displays</a>
</li>
                                    
<li >
    <a href="../../api/Stepper/">Stepper library</a>
</li>
                                    
<li >
    <a href="../../api/Servo/">Servo library</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Hardware <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../hardware/flashtool/">Flash tool</a>
</li>
                                    
<li >
    <a href="../../hardware/stm8blue/">Generic STM8S103F3 breakout board (stm8blue)</a>
</li>
                                    
<li >
    <a href="../../hardware/stm8s003/">Generic STM8S003 support</a>
</li>
                                    
<li >
    <a href="../../hardware/esp14/">ESP14 Wifi board (STM8S003F3P6)</a>
</li>
                                    
<li >
    <a href="../../hardware/w1209-thermostat/">W1209 thermostat board (STM8S003F3P6)</a>
</li>
                                    
<li >
    <a href="../../hardware/stm8sblack/">Generic STM8S105K4 breakout board (stm8sblack)</a>
</li>
                                    
<li >
    <a href="../../hardware/stm8sdiscovery/">STM8S105Discovery evaluation board made by ST (STM8S105C6)</a>
</li>
                                    
<li >
    <a href="https://github.com/roybaer/sduino_uno">sduino Uno (STM8S105K6), inspired by Arduino Uno</a>
</li>
                                    
<li >
    <a href="https://github.com/roybaer/sduino_mb">sduino MB (STM8S208MB), inspired by Arduino Mega</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../ide-integration/">IDE integration</a>
</li>
                                    
<li >
    <a href="../compiling-the-tools/">Compiling the tools</a>
</li>
                                    
<li >
    <a href="../cross-compile-for-osx/">Cross-compiling the tools for OSX</a>
</li>
                                    
<li >
    <a href="../update-to-manual/">Update an automatic installation to a manual installation</a>
</li>
                                    
<li class="active">
    <a href="./">C preprocessor macro magic</a>
</li>
                                    
<li >
    <a href="../pin_mapping/">Ways to define a pin mapping</a>
</li>
                                    
<li >
    <a href="../coding-style/">Coding style</a>
</li>
                                    
<li >
    <a href="../sdcc/">Using the SDCC compiler</a>
</li>
                                    
<li >
    <a href="../spl/">Using the SPL with SDCC and sduino</a>
</li>
                                    
<li >
    <a href="../bare-metal-programming/">Bare metal programming on the STM8</a>
</li>
                                    
<li >
    <a href="../optimizations/">Optimizations</a>
</li>
                                    
<li >
    <a href="../performance/">Performance comparison and benchmarking</a>
</li>
                                    
<li >
    <a href="../links/">Links and further reading</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../contact/">Contact</a>
                            </li>
                            <li >
                                <a href="../../about/">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../update-to-manual/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../pin_mapping/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/tenbaht/sduino/edit/master/docs/developer/macro.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#preprocessor-macros-to-disguise-plain-c-as-c">Preprocessor macros to disguise plain C as C++</a></li>
            <li><a href="#single-instance-pre-instantiated-with-constructor">Single-instance, pre-instantiated, with constructor</a></li>
            <li><a href="#single-instance-with-constructor">Single-instance, with constructor</a></li>
            <li><a href="#multi-instance-class-with-constructor">Multi-instance class, with constructor</a></li>
            <li><a href="#multi-instance-class-no-constructor">Multi-instance class, no constructor</a></li>
            <li><a href="#inheritance">Inheritance</a></li>
            <li><a href="#further-reading">Further reading</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="preprocessor-macros-to-disguise-plain-c-as-c">Preprocessor macros to disguise plain C as C++</h1>
<p>Porting some Arduino-like functions to C is not too difficult. The challenge
is to keep the syntax differences to the real C++-based Arduino system as
small a possible while still using plain C.</p>
<p>There are subtle differences in the API concepts of the Arduino libraries.
Unfortunatly, they all require different strategies to mimic a C++ user API.
The basic criteria are:</p>
<ul>
<li>
<p>multi-instance or single-instance</p>
</li>
<li>
<p>is a constructor call mandatory or not (typically the <code>begin()</code>-method)</p>
</li>
</ul>
<p>Additionally, there are some more detailed destinctions:</p>
<ul>
<li>
<p>polymorph instantiation declaration or simple declaration</p>
</li>
<li>
<p>general single instance library or pre-instantiated single instance
  library</p>
</li>
<li>
<p>inheritance via virtual methods (most output-type libraries inherit from
  the Print class)</p>
</li>
</ul>
<p>As a result, there are several different cases to consider:</p>
<h2 id="single-instance-pre-instantiated-with-constructor">Single-instance, pre-instantiated, with constructor</h2>
<p>The data is kept locally within the class module. There is no
  instantiation declaration. No instance references need to be passed to any
  any function calls. All initialization is done by the constructor
  function.</p>
<p>This is the easiest and most straight-forward case. No help from the
  preprocessor is required. It is sufficient to choose the function names to
  match the original class::method names. Polymorph methods are represented
  by a set of name-mangled functions.</p>
<p>The behaviour of this construction is very similar to a real C++ class.</p>
<p><strong>Examples:</strong>
<a href="../../api/SPI/">SPI</a>, <a href="../../api/I2C/">I2C</a>,
<a href="../../api/HardwareSerial/">HardwareSerial</a> </p>
<pre><code class="c">#include &lt;I2C.h&gt;

setup() {
    I2c_begin();
    I2c_write(0x1e, 0x02,0x00);
}

</code></pre>

<h3 id="required-preprocessor-help">Required preprocessor help</h3>
<ul>
<li>none</li>
</ul>
<h2 id="single-instance-with-constructor">Single-instance, with constructor</h2>
<p>The data is kept locally within the class module. The instantiation
  declaration defines the one instance name to be used. It might pass some
  configuration data which is remembered for later use. As there is always
  exactly one instance, no instance references need to be remembered and
  passed to any function calls. The instance name is more a cosmetic issue.</p>
<p>The constructor does the actual configuration and initialization. It might
  use the configuration data given earlier with the instantiation
  declaration.</p>
<p>The behaviour of this construction is very similar to a real C++ class.</p>
<p>Polymorph instantiation declarations are possible.
  Non-constant values for the initialization are supported.</p>
<p><strong>Examples:</strong> <a href="../../api/LiquidCrystal/">LiquidCrystal</a></p>
<pre><code class="c">int rs_pin = 2;

LiquidCrystal (lcd, rs_pin,3,4, 5,6,7,8);

setup() {
    lcd_begin(16,2);
    lcd_setCursor(0,1);
    lcd_print_s(&quot;Hello, world!&quot;);
}
</code></pre>

<h3 id="required-preprocessor-help_1">Required preprocessor help</h3>
<ul>
<li>polymorph instantiation</li>
<li>remember configuration data for later use with the constructor</li>
<li>setting up alias definitions to include the instance name in the function
  names.</li>
</ul>
<h2 id="multi-instance-class-with-constructor">Multi-instance class, with constructor</h2>
<p>The data can be kept locally within the class module. The constructor
  allocates and initializes the required data structure and does required
  I/O-initializations. It returns a reference item to identify the instance.
  This reference item is typically a pointer to the instance structure or
  and index number to an internal table. It is passed to any following
  method call.</p>
<p>The behaviour of this construction is very similar to a real C++ class.
  The main pitfall is the missing automatic destructor call. Luckily, this
  C++ feature is rarely used, anyway.</p>
<p>Polymorph instantiation declarations are possible.</p>
<p>Examples: <a href="../../api/Servo/">Servo</a></p>
<pre><code class="c">#include &lt;Servo.h&gt;

Servo(servo1);
Servo(servo2);

setup() {
    servo1_attach(5);
    servo2_attach(6);
}

loop() {
    servo1_write(90);
    servo2_write(150);
}
</code></pre>

<h3 id="required-preprocessor-help_2">Required preprocessor help</h3>
<ul>
<li>polymorph instantiation</li>
<li>remember configuration data for later use with the constructor</li>
<li>save the instance reference item on initialization</li>
<li>setting up alias definitions to </li>
<li>include the instance name in the function names and</li>
<li>include the instance reference item with the parameter list of every function call.</li>
</ul>
<h2 id="multi-instance-class-no-constructor">Multi-instance class, no constructor</h2>
<p>As there is no strictly defined first function call which could allocate
  and initialize internal data structures, the data has to be kept in a data
  structure in the user area. A pointer to this data structure is passed to
  any following method call.</p>
<p>This case can be difficult. As there is no dedicated constructor call, the
  library has to keep track if the current instance has been initialized
  already and has to do so if not. That means, that the needed I/O resources
  can't be initialized before the first function call. That might be a
  problem for some applications as I/O pins might stay in a floating input
  state for quite some time.</p>
<p>Second drawback of this concept is the fact, that the instance data
  initialization values have to be known at compile time and can't be
  variables or the result of function calls at run time, e.g. from a
  configuration space in EEPROM.</p>
<p>To solve these two problems it might be necessary to introduce an
  additional constructor-type function, that can be called from the setup()
  function or for any needed reconfiguration. Since the instance data is in
  the user space anyway, it could be modified there directly. But this would
  be an even worse violation of all modularization concepts and should be
  avoided.</p>
<p>Polymorph instantiation declarations are possible.</p>
<p>Examples: <a href="../../api/Stepper/">Stepper</a></p>
<p>By requiring the user to add a call to the added constructor as the
  mandatory first call to the instance it could be treated as any other
  multi-instance class with constructor, see above. The resulting API is not
  identical to Arduino anymore, but still very similar.</p>
<pre><code class="c">#include &lt;Stepper.h&gt;

Stepper (StepperA, 100, 6, 7);
Stepper (StepperB, 200, 8, 9, 10, 11);

void setup() {
  StepperA_setSpeed(60);
  StepperB_setSpeed(60);
}

void loop() {
  StepperA_step(20);
  StepperB_step(40);
}
</code></pre>

<h3 id="required-preprocessor-help_3">Required preprocessor help</h3>
<ul>
<li>polymorph instantiation.</li>
<li>convert the instantiation declaration into an instance data item declaration
  and initialization.</li>
<li>setting up alias definitions to </li>
<li>include the instance name in the function names and</li>
<li>include a pointer to the instance data item with the parameter list of
    every function call.</li>
</ul>
<h2 id="inheritance">Inheritance</h2>
<p>Most output-type libraries inherit the methods from class Print by providing
a matching write() method. This works by providing all print functions a
function pointer to the write function, that should be used.</p>
<h3 id="required-preprocessor-help_4">Required preprocessor help</h3>
<ul>
<li>setting up alias definitions to </li>
<li>include the instance name of the output module in the function names of
    the print functions and</li>
<li>include a pointer to the output write function with the parameter list of
    every (aliased) print function call.</li>
</ul>
<h2 id="further-reading">Further reading</h2>
<p>Polymorphism relies on variadic macros. Daniel Hardman wrote a very
understandable <a href="https://codecraft.co/2014/11/25/variadic-macros-tricks/">step-by-step
introduction</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
